# ====================================
# DOCKERFILE PARA DESARROLLO
# ====================================
# Este Dockerfile está optimizado para desarrollo local
# - Mantiene todas las dependencias (TypeScript, nodemon)
# - Hot reload automático con nodemon
# - No compila durante el build (usa ts-node/nodemon)
# ====================================

FROM node:18-alpine

# Instalar dependencias del sistema
RUN apk add --no-cache python3 make g++ libusb-dev eudev-dev linux-headers curl

WORKDIR /app

# Copiar archivos de configuración
COPY package*.json ./
COPY tsconfig.json ./

# Instalar TODAS las dependencias (desarrollo + producción)
# NO hacer npm prune para mantener TypeScript, nodemon, etc.
RUN npm install

# NO copiar el código fuente aquí - se montará como volumen
# Esto permite hot reload cuando editas archivos localmente

# Crear usuario no-root para seguridad
RUN addgroup -g 1001 -S nodejs && \
    adduser -S santitelas -u 1001 -G nodejs

# Crear directorio de logs
RUN mkdir -p /app/logs && \
    chown -R santitelas:nodejs /app

USER santitelas

EXPOSE 5000

# Variables de entorno para desarrollo
ENV NODE_ENV=development
ENV PORT=5000

# Usar nodemon para hot reload automático
# nodemon monitorea cambios en archivos .ts y reinicia automáticamente
CMD ["npm", "run", "dev"]

# Health check para Docker
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD curl -f http://localhost:5000/api/health || exit 1
